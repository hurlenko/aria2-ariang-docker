From b98c68d13b120d2cd2bf83a4ec4d146909e294bc Mon Sep 17 00:00:00 2001
From: FindlayFeng <i@fengch.me>
Date: Sat, 24 Jun 2023 20:33:53 +0800
Subject: [PATCH] =?UTF-8?q?=E4=BF=AE=E6=94=B9=20RPC=E8=BF=9E=E6=8E=A5?=
 =?UTF-8?q?=E7=9A=84=E9=BB=98=E8=AE=A4=E5=80=BC?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: FindlayFeng <i@fengch.me>
---
 src/scripts/services/ariaNgSettingService.js | 31 +++++++++++++++++---
 1 file changed, 27 insertions(+), 4 deletions(-)

diff --git a/src/scripts/services/ariaNgSettingService.js b/src/scripts/services/ariaNgSettingService.js
index 2d9b633..2a6f818 100644
--- a/src/scripts/services/ariaNgSettingService.js
+++ b/src/scripts/services/ariaNgSettingService.js
@@ -134,6 +134,31 @@
             return ariaNgConstants.defaultHost;
         };
 
+        var getDefaultRpcProtocol = function () {
+            if (isInsecureProtocolDisabled()) {
+                return ariaNgConstants.defaultSecureProtocol;
+            }
+
+            return "http";
+        }
+
+        var getDefaultRpcPort = function () {
+            var currentPort = window.location.port;
+
+            if (currentPort) {
+                return currentPort;
+            }
+
+            switch  (getDefaultRpcProtocol()) {
+                case "https":
+                    return "443";
+                case "http":
+                    return "80";
+                default:
+                    return "6800";
+            }
+        }
+
         var setOptions = function (options) {
             return ariaNgStorageService.set(ariaNgConstants.optionStorageKey, options);
         };
@@ -194,10 +219,8 @@
 
         var initRpcSettingWithDefaultHostAndProtocol = function (setting) {
             setting.rpcHost = getDefaultRpcHost();
-
-            if (isInsecureProtocolDisabled()) {
-                setting.protocol = ariaNgConstants.defaultSecureProtocol;
-            }
+            setting.rpcPort= getDefaultRpcPort();
+            setting.protocol = getDefaultRpcProtocol();
         };
 
         var cloneRpcSetting = function (setting) {
-- 
2.41.0

